<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  addDoc,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore.js";

import { 
  getStorage, 
  ref, 
  uploadBytesResumable, 
  getDownloadURL 
} from "https://www.gstatic.com/firebasejs/9.1.3/firebase-storage.js";

/* CONFIGURACIÓN FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyCQd2Aw91y8Kb0c9EoDJTd9FvdlsfRSDqI",
  authDomain: "kindo-mall.firebaseapp.com",
  projectId: "kindo-mall",
  storageBucket: "kindo-mall.appspot.com",
  messagingSenderId: "463969508011",
  appId: "1:463969508011:web:1ee78cb55a67dc0a27f5ee"
};

/* INICIALIZAR */
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

console.log("Firebase conectado");

/* SUBIR IMAGEN */
window.uploadImage = function(file) {
  const storageRef = ref(storage, "images/" + file.name);
  const uploadTask = uploadBytesResumable(storageRef, file);

  return new Promise((resolve, reject) => {
    uploadTask.on(
      "state_changed",
      null,
      reject,
      () => getDownloadURL(uploadTask.snapshot.ref).then(resolve)
    );
  });
};

/* GUARDAR PRODUCTO */
window.saveProduct = async function(title, price, desc, imgs) {
  await addDoc(collection(db, "products"), {
    title,
    price,
    description: desc,
    images: imgs
  });
};

/* PRODUCTOS EN MEMORIA */
window.products = [];

/* ESCUCHAR CAMBIOS EN TIEMPO REAL */
function listenProducts() {
  onSnapshot(collection(db, "products"), snapshot => {
    window.products = [];

    snapshot.forEach(doc => {
      window.products.push({
        id: doc.id,
        ...doc.data()
      });
    });

    if (window.renderProducts) renderProducts();
  });
}

/* INICIAR CUANDO CARGA LA PÁGINA */
window.addEventListener("DOMContentLoaded", () => {
  listenProducts();
});
</script>
